var fs = require("fs");
var path = require("path");


function checkpaths(pathMap, callback) {
    var MAX_PARALLEL = 1000;
    var cache = {};
    var t = Date.now();
    var result = {};
    ///////////////////////////////////////////////////////////////////////////
    cache.files = {};
    fs.readdirSync(__dirname).forEach(function(x) {
        cache[__dirname + "/" + x] = 0;
    });
    ///////////////////////////////////////////////////////////////////////////
    
    var pending = Object.keys(cache.files);
    var count = 0;
    var cb = function(e, stat, p) {
        var mtime = stat.mtime.getTime();
        var isClean = mtime < cache.files[p];
        
        if (!count && !pending.length) {
            console.log(t - Date.now());
            callback(null, result);
        }
    };
    var take = function() {
        while (count < MAX_PARALLEL) {
            var p = pending.pop();
            if (!p) break;
            count++;
            (function(p) {
                fs.stat(p, function(e, stat) {
                    count--;
                    cb(e, stat, p);
                    take();
                });
            })(p);
        }
    };
    take();
}


